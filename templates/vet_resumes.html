<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Vetting - AI Powered HR Assistant</title>
    
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Unified Styles -->
    <link rel="stylesheet" href="/static/css/unified_styles.css">
    <style>
        body { background: #f5f7fa; font-family: 'Segoe UI', Tahoma, sans-serif; }
        .card { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: none; margin-bottom: 20px; }
        .upload-zone { border: 3px dashed #dee2e6; border-radius: 12px; padding: 50px 30px; text-align: center; transition: all 0.3s; cursor: pointer; background: white; }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: #f0f7ff; }
        .score-badge { font-size: 1.2em; font-weight: bold; padding: 6px 12px; border-radius: 6px; display: inline-block; margin-bottom: 8px; color: #333; }
        .score-high { background: #198754; color: white; }
        .score-medium { background: #ffc107; color: #000; font-weight: 700; }
        .score-low { background: #dc3545; color: white; }
        .score-details { font-size: 0.85em; line-height: 1.6; }
        .resume-row { cursor: pointer; transition: all 0.2s; }
        .resume-row:hover { background: #f8f9fa; }
        .component-score { margin-bottom: 10px; }
        .progress { height: 20px; border-radius: 4px; font-size: 0.85em; }
        .flag-badge { font-size: 0.85em; padding: 4px 8px; margin: 2px; }
        .stats-card { text-align: center; padding: 15px; border-radius: 8px; margin: 5px; }
        .stats-total { background: #e3f2fd; color: #1976d2; }
        .stats-approved { background: #e8f5e9; color: #388e3c; }
        .stats-rejected { background: #ffebee; color: #d32f2f; }
        .stats-pending { background: #fff3e0; color: #f57c00; }
        .bulk-actions { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .details-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Unified Navigation -->
    {% include 'components/unified_navbar.html' %}

    <div class="container pt-5">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="bi bi-shield-shaded me-2"></i>Resume Authenticity Vetting</h2>
                <p class="text-muted">Scan resumes for authenticity before adding to database. Only approved resumes will be saved.</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="card" id="uploadSection">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-cloud-upload me-2"></i>Upload Resumes for Vetting</h5>
                <form id="vetForm">
                    <div class="upload-zone" id="uploadZone">
                        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx" class="d-none">
                        <i class="bi bi-cloud-arrow-up" style="font-size: 48px; color: var(--primary);"></i>
                        <h5 class="mt-3">Drag & Drop Resumes Here</h5>
                        <p class="text-muted">or click to browse (Max 50 files, PDF/DOC/DOCX)</p>
                        <div id="fileList" class="mt-3 text-start"></div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Job Description (Optional - for matching analysis)</label>
                        <textarea class="form-control" id="jobDescription" rows="3" placeholder="Paste job description here..."></textarea>
                    </div>
                    
                    <!-- LLM Extraction Toggle -->
                    <div class="mt-3 p-3 border rounded bg-light">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useLLMExtraction" checked>
                            <label class="form-check-label" for="useLLMExtraction">
                                <strong>🤖 Use AI-Powered Extraction (Recommended)</strong>
                            </label>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i> 
                            <strong>AI Mode:</strong> Uses advanced language models (Gemini/OpenAI) for 95%+ accuracy across all resume formats.
                            <br>
                            <strong>Standard Mode:</strong> Uses traditional OCR + pattern matching (faster but less accurate).
                        </small>
                        <div class="mt-2" id="llmProviderSelection">
                            <label class="form-label small"><strong>AI Provider:</strong></label>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="llmProvider" id="providerGemini" value="gemini" checked>
                                <label class="btn btn-outline-primary" for="providerGemini">
                                    <i class="bi bi-google"></i> Gemini (Free)
                                </label>
                                
                                <input type="radio" class="btn-check" name="llmProvider" id="providerOpenAI" value="openai">
                                <label class="btn btn-outline-success" for="providerOpenAI">
                                    <i class="bi bi-stars"></i> OpenAI (Paid)
                                </label>
                            </div>
                        </small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg mt-3" id="scanBtn">
                        <i class="bi bi-search me-2"></i>Scan Resumes for Authenticity
                    </button>
                </form>
            </div>
        </div>

        <!-- Scanning Progress -->
        <div class="card hidden" id="scanningSection">
            <div class="card-body">
                <h5><i class="bi bi-hourglass-split me-2"></i>Scanning in Progress...</h5>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="scanProgress" style="width: 0%"></div>
                </div>
                <p class="text-center mt-2" id="scanStatus">Scanning file 1 of 10...</p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row hidden" id="statsSection">
            <div class="col-md-3"><div class="stats-card stats-total"><h4 id="statTotal">0</h4><small>Total Scanned</small></div></div>
            <div class="col-md-3"><div class="stats-card stats-approved"><h4 id="statApproved">0</h4><small>Approved</small></div></div>
            <div class="col-md-3"><div class="stats-card stats-rejected"><h4 id="statRejected">0</h4><small>Rejected</small></div></div>
            <div class="col-md-3"><div class="stats-card stats-pending"><h4 id="statPending">0</h4><small>Pending Review</small></div></div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions hidden" id="bulkActions">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="selectAll()"><i class="bi bi-check-square"></i> Select All</button>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="deselectAll()"><i class="bi bi-square"></i> Deselect All</button>
                    <button class="btn btn-sm btn-success me-2" onclick="approveSelected()"><i class="bi bi-check-lg"></i> Approve Selected</button>
                    <button class="btn btn-sm btn-danger me-2" onclick="rejectSelected()"><i class="bi bi-x-lg"></i> Reject Selected</button>
                </div>
                <div class="col-md-6 text-end">
                    <input type="number" id="scoreThreshold" class="form-control d-inline-block" style="width: 80px;" value="70" min="0" max="100">
                    <button class="btn btn-sm btn-info me-2" onclick="approveByScore()"><i class="bi bi-filter"></i> Approve Score ≥</button>
                    <button class="btn btn-primary btn-lg" onclick="uploadApproved()"><i class="bi bi-database-add"></i> Upload Approved to Database</button>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card hidden" id="resultsSection">
            <div class="card-body">
                <h5><i class="bi bi-list-check me-2"></i>Vetting Results</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="50"><input type="checkbox" id="selectAllCheck" onclick="toggleSelectAll()"></th>
                                <th>Resume</th>
                                <th>Authenticity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="uploadSuccessModal" tabindex="-1" aria-labelledby="uploadSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="uploadSuccessModalLabel">
                        <i class="bi bi-check-circle-fill me-2"></i>Upload Successful!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                    </div>
                    <div id="uploadSuccessMessage"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="location.reload()">Stay Here</button>
                    <button type="button" class="btn btn-primary" onclick="window.location.href='/candidates'">
                        <i class="bi bi-people me-1"></i>View Candidates
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="uploadErrorModal" tabindex="-1" aria-labelledby="uploadErrorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="uploadErrorModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Upload Failed
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-x-circle text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <div id="uploadErrorMessage"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmUploadModal" tabindex="-1" aria-labelledby="confirmUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="confirmUploadModalLabel">
                        <i class="bi bi-database-add me-2"></i>Confirm Upload
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-question-circle text-primary" style="font-size: 4rem;"></i>
                    </div>
                    <p class="lead text-center">Upload all approved resumes to database?</p>
                    <p class="text-muted text-center mb-0">This will permanently add them to the candidate database and trigger background processing.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmUploadAction()">
                        <i class="bi bi-check-circle me-1"></i>Yes, Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Widget -->
    {% include 'components/feedback_widget.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sessionId = null;
        let scannedResumes = [];
        let selectedHashes = new Set();

        // File upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            displayFileList();
        });

        fileInput.addEventListener('change', displayFileList);

        function displayFileList() {
            const files = fileInput.files;
            const fileList = document.getElementById('fileList');
            if (files.length > 0) {
                fileList.innerHTML = `<strong>${files.length} file(s) selected:</strong><br>` +
                    Array.from(files).slice(0, 5).map(f => `<small>• ${f.name}</small>`).join('<br>') +
                    (files.length > 5 ? `<br><small>... and ${files.length - 5} more</small>` : '');
            }
        }

        // Scan form submission
        document.getElementById('vetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = fileInput.files;
            if (files.length === 0) { alert('Please select files'); return; }
            if (files.length > 50) { alert('Maximum 50 files allowed'); return; }

            sessionId = generateSessionId();
            await scanResumes(files);
        });

        async function scanResumes(files) {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('scanningSection').classList.remove('hidden');

            const jobDesc = document.getElementById('jobDescription').value;
            const useLLM = document.getElementById('useLLMExtraction').checked;
            const llmProvider = document.querySelector('input[name="llmProvider"]:checked')?.value || 'gemini';
            let scanned = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', sessionId);
                if (jobDesc) formData.append('job_description', jobDesc);
                formData.append('use_llm', useLLM);
                formData.append('llm_provider', llmProvider);

                try {
                    document.getElementById('scanStatus').textContent = `Scanning ${file.name} (${i + 1} of ${files.length})...`;
                    const response = await fetch('/api/v1/vetting/scan', { method: 'POST', body: formData });
                    const result = await response.json();
                    scannedResumes.push(result);
                    scanned++;
                } catch (error) {
                    console.error(`Error scanning ${file.name}:`, error);
                }

                const progress = ((i + 1) / files.length) * 100;
                document.getElementById('scanProgress').style.width = progress + '%';
            }

            document.getElementById('scanningSection').classList.add('hidden');
            displayResults();
        }

        function displayResults() {
            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('bulkActions').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            scannedResumes.forEach((resume, index) => {
                const scan = resume.scan_result;
                const comp = scan.comprehensive_analysis || {};
                const finalScore = comp.final_score || scan.authenticity_score?.overall_score || 0;
                const scoreClass = finalScore >= 75 ? 'high' : finalScore >= 60 ? 'medium' : 'low';

                const row = `
                    <tr class="resume-row" data-hash="${resume.file_hash}">
                        <td><input type="checkbox" class="resume-check" data-hash="${resume.file_hash}" onchange="updateSelection('${resume.file_hash}', this.checked)"></td>
                        <td>
                            <strong>${scan.filename}</strong><br>
                            <small class="text-muted">${formatFileSize(scan.file_size)}</small>
                        </td>
                        <td>
                            <div><span class="score-badge score-${scoreClass}">${Math.round(finalScore)}%</span></div>
                            <div class="score-details">
                                <small class="d-block">Base: ${Math.round(comp.base_authenticity_score || finalScore)}%</small>
                                ${comp.job_hopping_impact ? `<small class="d-block text-danger">Job Hop: ${comp.job_hopping_impact} pts</small>` : ''}
                                ${comp.job_hopping && comp.job_hopping.risk_level && comp.job_hopping.risk_level !== 'none' ? 
                                    `<span class="badge bg-warning">⚠️ ${comp.job_hopping.risk_level} risk</span>` : ''}
                                ${comp.education_verification && comp.education_verification.discrepancy_count > 0 ? 
                                    `<span class="badge bg-danger">🎓 ${comp.education_verification.discrepancy_count} edu issue${comp.education_verification.discrepancy_count > 1 ? 's' : ''}</span>` : ''}
                            </div>
                            ${scan.authenticity_score.flags && scan.authenticity_score.flags.length > 0 ?
                                `<span class="badge bg-danger flag-badge">🚩 ${scan.authenticity_score.flags.length} flags</span>` : ''}
                        </td>
                        <td id="status-${resume.file_hash}"><span class="badge bg-secondary">Pending</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="approveResume('${resume.file_hash}')"><i class="bi bi-check"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="rejectResume('${resume.file_hash}')"><i class="bi bi-x"></i></button>
                            <button class="btn btn-sm btn-info" onclick="toggleDetails('${resume.file_hash}')"><i class="bi bi-info-circle"></i></button>
                        </td>
                    </tr>
                    <tr class="hidden" id="details-${resume.file_hash}">
                        <td colspan="5">
                            <div class="details-panel">${generateDetailsHTML(scan)}</div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            updateStats();
        }

        function generateDetailsHTML(scan) {
            const auth = scan.authenticity_score;
            const match = scan.matching_score;
            const diagnostics = auth.diagnostics || {};
            
            return `
                <!-- Quick Summary -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><i class="bi bi-clipboard-data"></i> Detailed Authenticity Analysis</h6>
                        <div class="component-score">
                            <strong>Font Consistency:</strong> ${Math.round(auth.font_consistency || 0)}%
                            <div class="progress"><div class="progress-bar bg-success" style="width: ${auth.font_consistency || 0}%"></div></div>
                        </div>
                        <div class="component-score">
                            <strong>Grammar Quality:</strong> ${Math.round(auth.grammar_score || 0)}%
                            <div class="progress"><div class="progress-bar bg-success" style="width: ${auth.grammar_score || 0}%"></div></div>
                        </div>
                        <div class="component-score">
                            <strong>Formatting:</strong> ${Math.round(auth.formatting_score || 0)}%
                            <div class="progress"><div class="progress-bar bg-success" style="width: ${auth.formatting_score || 0}%"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="component-score">
                            <strong>LinkedIn Profile:</strong> ${Math.round(auth.linkedin_profile_score || 0)}%
                            <div class="progress"><div class="progress-bar bg-success" style="width: ${auth.linkedin_profile_score || 0}%"></div></div>
                        </div>
                        <div class="component-score">
                            <strong>Capitalization:</strong> ${Math.round(auth.capitalization_score || 0)}%
                            <div class="progress"><div class="progress-bar bg-success" style="width: ${auth.capitalization_score || 0}%"></div></div>
                        </div>
                        <div class="component-score">
                            <strong>Visual Consistency:</strong> ${Math.round(auth.visual_consistency || 0)}%
                            <div class="progress"><div class="progress-bar bg-success" style="width: ${auth.visual_consistency || 0}%"></div></div>
                        </div>
                    </div>
                </div>
                
                ${auth.flags && auth.flags.length > 0 ? `
                    <div class="alert alert-warning mb-3">
                        <h6><i class="bi bi-flag"></i> Flags Detected (${auth.flags.length}):</h6>
                        ${auth.flags.map(flag => `
                            <div class="mb-2">
                                <span class="badge bg-${flag.severity === 'high' ? 'danger' : flag.severity === 'medium' ? 'warning' : 'info'}">  
                                    ${flag.severity === 'high' ? '🔴' : flag.severity === 'medium' ? '🟡' : 'ℹ️'} ${flag.severity.toUpperCase()}
                                </span>
                                <strong>${flag.category}:</strong> ${flag.message}
                            </div>
                        `).join('')}
                    </div>
                ` : '<div class="alert alert-success mb-3">✅ No authenticity issues detected</div>'}
                
                ${match ? `
                    <div class="card mb-3" style="background: #fff3cd;">
                        <div class="card-body">
                            <h6><i class="bi bi-bullseye"></i> Job Description Matching Analysis</h6>
                            <h5 class="mb-3">Overall Match: ${Math.round(match.overall_match || 0)}%</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Skills Match:</strong>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-${match.skills_match >= 80 ? 'success' : match.skills_match >= 60 ? 'warning' : 'danger'}" 
                                             style="width: ${match.skills_match || 0}%">${Math.round(match.skills_match || 0)}%</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <strong>Experience Match:</strong>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-${match.experience_match >= 80 ? 'success' : match.experience_match >= 60 ? 'warning' : 'danger'}" 
                                             style="width: ${match.experience_match || 0}%">${Math.round(match.experience_match || 0)}%</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <strong>Education Match:</strong>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-${match.education_match >= 80 ? 'success' : match.education_match >= 60 ? 'warning' : 'danger'}" 
                                             style="width: ${match.education_match || 0}%">${Math.round(match.education_match || 0)}%</div>
                                    </div>
                                </div>
                            </div>
                            ${match.matched_skills && match.matched_skills.length > 0 ? `
                                <div class="mt-2">
                                    <strong class="text-success">✓ Matched Skills:</strong>
                                    ${match.matched_skills.map(skill => `<span class="badge bg-success">${skill}</span>`).join(' ')}
                                </div>
                            ` : ''}
                            ${match.missing_skills && match.missing_skills.length > 0 ? `
                                <div class="mt-2">
                                    <strong class="text-danger">✗ Missing Skills:</strong>
                                    ${match.missing_skills.map(skill => `<span class="badge bg-danger">${skill}</span>`).join(' ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                <div class="text-center mt-3">
                    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detailedDiagnostics-${scan.file_hash || Math.random()}">
                        🔍 View Detailed Diagnostics
                    </button>
                </div>
                
                <div class="collapse mt-3" id="detailedDiagnostics-${scan.file_hash || Math.random()}">
                    <div class="card card-body">
                        ${generateFullDiagnosticsHTML(diagnostics, match)}
                    </div>
                </div>
            `;
        }
        
        function generateFullDiagnosticsHTML(diagnostics, matchingScore = null) {
            let html = '<h6 class="mb-3">📋 Detailed Analysis Report</h6>';
            
            // JD Matching Diagnostics (if available)
            if (matchingScore) {
                const getScoreColor = (score) => score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">🎯 Job Description Matching Analysis</h6>
                        <div class="alert alert-${getScoreColor(matchingScore.overall_match)}">
                            <h6 class="alert-heading">Overall Match: ${Math.round(matchingScore.overall_match || 0)}%</h6>
                            <hr>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Skills Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.skills_match || 0)}" 
                                             style="width: ${matchingScore.skills_match || 0}%">
                                            ${Math.round(matchingScore.skills_match || 0)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Experience Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.experience_match || 0)}" 
                                             style="width: ${matchingScore.experience_match || 0}%">
                                            ${Math.round(matchingScore.experience_match || 0)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Education Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.education_match || 0)}" 
                                             style="width: ${matchingScore.education_match || 0}%">
                                            ${Math.round(matchingScore.education_match || 0)}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${matchingScore.matched_skills && matchingScore.matched_skills.length > 0 ? `
                                <div class="mb-3">
                                    <p class="mb-2"><strong>✓ Matched Skills (${matchingScore.matched_skills.length}):</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${matchingScore.matched_skills.map(skill => `<span class="badge bg-success">${skill}</span>`).join('')}
                                    </div>
                                </div>
                            ` : '<p class="mb-2 text-muted">No skills matched from the job description.</p>'}
                            
                            ${matchingScore.missing_skills && matchingScore.missing_skills.length > 0 ? `
                                <div class="mb-3">
                                    <p class="mb-2"><strong>✗ Missing Skills (${matchingScore.missing_skills.length}):</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${matchingScore.missing_skills.map(skill => `<span class="badge bg-danger">${skill}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${matchingScore.details && matchingScore.details.length > 0 ? `
                                <div class="mt-3">
                                    <p class="mb-2"><strong>📝 Detailed Feedback:</strong></p>
                                    <ul class="mb-0">
                                        ${matchingScore.details.map(detail => `<li>${detail}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 p-2 bg-light rounded">
                                <small class="text-muted">
                                    <strong>💡 Matching Algorithm:</strong> This score is calculated based on weighted factors: 
                                    Skills (50%), Experience (30%), and Education (20%). The algorithm uses keyword matching 
                                    and considers both required and bonus qualifications.
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Check if diagnostics exists
            if (!diagnostics || Object.keys(diagnostics).length === 0) {
                if (!matchingScore) {
                    html += `
                        <div class="alert alert-warning">
                            <p class="mb-0">⚠️ Detailed diagnostics are not available for this resume.</p>
                            <small>This may occur with older analysis results or if the document format is not fully supported.</small>
                        </div>
                    `;
                }
                return html;
            }
            
            html += '<h6 class="text-primary mb-3">🔍 Authenticity Analysis Details</h6>';
            
            // LinkedIn Diagnostics - Full version with search links
            if (diagnostics.linkedin) {
                html += `<div class="mb-4"><h6 class="text-primary">🔗 Professional Profile Analysis</h6>`;
                
                if (diagnostics.linkedin.profile) {
                    const profile = diagnostics.linkedin.profile;
                    const resumeStatus = profile.cross_verified ? 'success' : 'warning';
                    html += `
                        <div class="alert alert-${resumeStatus} mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">📄</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Found in Resume</strong></p>
                                    <p class="mb-1">
                                        <strong>LinkedIn URL:</strong> 
                                        <a href="${profile.url}" target="_blank" class="text-decoration-none">${profile.url} ↗</a>
                                    </p>
                                    <p class="mb-0"><strong>Username:</strong> <code>${profile.username}</code></p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (diagnostics.linkedin.verification_details) {
                    html += `
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">📄</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Not Found in Resume</strong></p>
                                    <p class="mb-0"><small>No LinkedIn URL detected in the resume. However, we found a profile through online search (see below).</small></p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Online Verification with Search Engine Links
                if (diagnostics.linkedin.verification_details) {
                    const details = diagnostics.linkedin.verification_details;
                    html += `
                        <div class="alert alert-info mb-3" style="border-left: 4px solid #0077b5;">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">🔍</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Online Verification Results</strong></p>
                                    <div class="mb-2">
                                        <span class="badge bg-success me-2">✓ Verified</span>
                                        <span class="badge bg-info">via ${details.search_engine}</span>
                                    </div>
                                    
                                    ${details.search_url ? `
                                        <p class="mb-2">
                                            <strong>Verification Source:</strong><br>
                                            <a href="${details.search_url}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">
                                                🔍 View ${details.search_engine} Search: "${details.search_query}"
                                            </a>
                                        </p>
                                    ` : ''}
                                    
                                    ${details.matched_profiles && details.matched_profiles.length > 0 ? `
                                        <div class="mt-2">
                                            <strong>Matched LinkedIn Profile(s):</strong>
                                            <ul class="list-unstyled mt-1 mb-0">
                                                ${details.matched_profiles.slice(0, 3).map(profile => {
                                                    // Ensure profile has https:// prefix
                                    let profileUrl = profile;
                                    if (!profileUrl.startsWith('http://') && !profileUrl.startsWith('https://')) {
                                        profileUrl = 'https://' + profileUrl;
                                    }
                                                    return `
                                                    <li class="mb-1">
                                                        <a href="${profileUrl}" target="_blank" class="text-decoration-none">
                                                            💼 ${profile}
                                                        </a>
                                                    </li>
                                                `}).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="mt-2 p-2 bg-light rounded">
                                        <small class="text-muted">
                                            <strong>💡 Why this matters:</strong> HR can click the verification link to confirm this is the correct person and not someone with a similar name.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (diagnostics.linkedin.profile && diagnostics.linkedin.profile.cross_verified === false) {
                    html += `
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">⚠️</span>
                                <div style="flex: 1;">
                                    <p class="mb-1"><strong>Could Not Verify Online</strong></p>
                                    <small>The LinkedIn profile from the resume could not be found through online search. This may indicate a deleted profile or privacy settings.</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (diagnostics.linkedin.alternatives && diagnostics.linkedin.alternatives.length > 0) {
                    html += `
                        <div class="alert alert-secondary mb-3">
                            <p class="mb-2"><strong>Alternative Profiles Found:</strong></p>
                            <ul class="mb-0">
                                ${diagnostics.linkedin.alternatives.map(alt => `
                                    <li>
                                        <strong>${alt.platform}:</strong> 
                                        <a href="${alt.url}" target="_blank" class="text-decoration-none">${alt.url} ↗</a>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            // Capitalization Diagnostics
            if (diagnostics.capitalization) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">✍️ Capitalization Analysis</h6>
                        <p><strong>Issues Found:</strong> ${diagnostics.capitalization.issues_found}</p>
                        ${diagnostics.capitalization.details.map(issue => `
                            <div class="alert alert-${issue.severity === 'high' ? 'danger' : issue.severity === 'medium' ? 'warning' : 'info'} mb-2">
                                <h6 class="alert-heading">${issue.type}</h6>
                                ${issue.message ? `<p class="mb-0">${issue.message}</p>` : ''}
                                ${issue.count ? `<p class="mb-1"><strong>Count:</strong> ${issue.count} occurrences</p>` : ''}
                                ${issue.examples ? `
                                    <p class="mb-1"><strong>Examples:</strong></p>
                                    ${Array.isArray(issue.examples) ? `
                                        <ul class="mb-1">
                                            ${issue.examples.map(ex => `<li><code>${typeof ex === 'object' ? JSON.stringify(ex) : ex}</code></li>`).join('')}
                                        </ul>
                                    ` : `<code>${JSON.stringify(issue.examples)}</code>`}
                                ` : ''}
                                ${issue.fix ? `<p class="mb-0"><strong>💡 Fix:</strong> ${issue.fix}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Font Diagnostics
            if (diagnostics.fonts) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">🔤 Font Usage Analysis</h6>
                        <div class="alert alert-info">
                            <p class="mb-2"><strong>${diagnostics.fonts.recommendation}</strong></p>
                            <p class="mb-1"><strong>Total Unique Fonts:</strong> ${diagnostics.fonts.total_unique_fonts}</p>
                            ${diagnostics.fonts.fonts_breakdown && Object.keys(diagnostics.fonts.fonts_breakdown).length > 0 ? `
                                <p class="mb-1"><strong>Font Breakdown:</strong></p>
                                <ul class="mb-0">
                                    ${Object.entries(diagnostics.fonts.fonts_breakdown).map(([font, count]) => `
                                        <li><strong>${font}:</strong> ${count} ${typeof count === 'number' ? 'times' : ''}</li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Grammar Diagnostics
            if (diagnostics.grammar) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">📝 Grammar & Content Analysis</h6>
                        <p><strong>Issues Found:</strong> ${diagnostics.grammar.issues_found}</p>
                        ${diagnostics.grammar.details.map(issue => `
                            <div class="alert alert-${issue.severity === 'high' ? 'danger' : issue.severity === 'medium' ? 'warning' : 'info'} mb-2">
                                <h6 class="alert-heading">${issue.type}</h6>
                                ${issue.message ? `<p class="mb-0">${issue.message}</p>` : ''}
                                ${issue.count ? `<p class="mb-1"><strong>Count:</strong> ${issue.count} occurrences</p>` : ''}
                                ${issue.examples ? `
                                    <p class="mb-1"><strong>Examples:</strong></p>
                                    <ul class="mb-1">
                                        ${issue.examples.map(ex => `<li><code>${ex}</code></li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${issue.fix ? `<p class="mb-0"><strong>💡 Fix:</strong> ${issue.fix}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return html;
        }

        function toggleDetails(hash) {
            const row = document.getElementById(`details-${hash}`);
            row.classList.toggle('hidden');
        }

        async function approveResume(hash) {
            await fetch(`/api/v1/vetting/session/${sessionId}/approve/${hash}`, { method: 'POST' });
            document.getElementById(`status-${hash}`).innerHTML = '<span class="badge bg-success">Approved</span>';
            updateStats();
        }

        async function rejectResume(hash) {
            await fetch(`/api/v1/vetting/session/${sessionId}/reject/${hash}`, { method: 'POST' });
            document.getElementById(`status-${hash}`).innerHTML = '<span class="badge bg-danger">Rejected</span>';
            updateStats();
        }

        function updateSelection(hash, checked) {
            if (checked) selectedHashes.add(hash); else selectedHashes.delete(hash);
        }

        function selectAll() { document.querySelectorAll('.resume-check').forEach(cb => { cb.checked = true; selectedHashes.add(cb.dataset.hash); }); }
        function deselectAll() { document.querySelectorAll('.resume-check').forEach(cb => { cb.checked = false; selectedHashes.clear(); }); }

        async function approveSelected() {
            for (const hash of selectedHashes) await approveResume(hash);
        }

        async function rejectSelected() {
            for (const hash of selectedHashes) await rejectResume(hash);
        }

        async function approveByScore() {
            const threshold = document.getElementById('scoreThreshold').value;
            await fetch(`/api/v1/vetting/session/${sessionId}/bulk-approve?min_score=${threshold}`, { method: 'POST' });
            location.reload();
        }

        async function uploadApproved() {
            // Show confirmation modal instead of alert
            const modal = new bootstrap.Modal(document.getElementById('confirmUploadModal'));
            modal.show();
        }

        async function confirmUploadAction() {
            // Close confirmation modal
            const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmUploadModal'));
            confirmModal.hide();
            
            try {
                const response = await fetch(`/api/v1/vetting/session/${sessionId}/upload-approved`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showErrorModal(`Upload failed: ${error.detail || 'Unknown error'}`);
                    return;
                }
                
                const data = await response.json();
                
                const failedList = data.failed_resumes || [];
                
                if (data.uploaded === 0 && failedList.length === 0) {
                    showErrorModal(`No resumes were uploaded.`);
                    return;
                }
                
                // Build detailed message with duplicate detection
                let message = '';
                
                if (data.uploaded > 0) {
                    message += `<p class="lead"><strong>${data.uploaded}</strong> resume(s) successfully uploaded to database!</p>`;
                    message += `<p><i class="bi bi-info-circle text-info me-2"></i>They are now being processed in the background.</p>`;
                }
                
                if (failedList.length > 0) {
                    message += `<hr><div class="alert alert-warning mb-0">`;
                    message += `<h6><i class="bi bi-exclamation-triangle me-2"></i>Skipped Resumes (${failedList.length})</h6>`;
                    message += `<ul class="mb-0 small">`;
                    failedList.forEach(fail => {
                        const icon = fail.status === 'duplicate' ? '🔄' : '❌';
                        message += `<li>${icon} <strong>${fail.file_name}</strong>: ${fail.reason}</li>`;
                    });
                    message += `</ul></div>`;
                }
                
                showSuccessModal(message);
                
            } catch (error) {
                console.error('Upload error:', error);
                showErrorModal('Upload failed: ' + error.message);
            }
        }

        function showSuccessModal(message) {
            document.getElementById('uploadSuccessMessage').innerHTML = message;
            const modal = new bootstrap.Modal(document.getElementById('uploadSuccessModal'));
            modal.show();
        }

        function showErrorModal(message) {
            document.getElementById('uploadErrorMessage').innerHTML = `<p class="text-danger">${message}</p>`;
            const modal = new bootstrap.Modal(document.getElementById('uploadErrorModal'));
            modal.show();
        }

        async function updateStats() {
            const response = await fetch(`/api/v1/vetting/session/${sessionId}`);
            const session = await response.json();
            document.getElementById('statTotal').textContent = Object.keys(session.scanned_resumes).length;
            document.getElementById('statApproved').textContent = session.approved.length;
            document.getElementById('statRejected').textContent = session.rejected.length;
            document.getElementById('statPending').textContent = Object.keys(session.scanned_resumes).length - session.approved.length - session.rejected.length;
        }

        function generateSessionId() { return 'vet_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); }
        function formatFileSize(bytes) { const sizes = ['Bytes', 'KB', 'MB']; if (bytes === 0) return '0 Bytes'; const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024))); return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i]; }
        function toggleSelectAll() { const checked = document.getElementById('selectAllCheck').checked; if (checked) selectAll(); else deselectAll(); }
    </script>
</body>
</html>
