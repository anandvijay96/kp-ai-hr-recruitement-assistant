<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Resume - AI HR Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }
        .badge {
            font-size: 0.75em;
        }
        .text-sm {
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">🤖 AI HR Assistant</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/upload">Resume Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/candidates">Candidate Database</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="text-center mb-4">Upload Resume for Analysis</h2>

                <!-- Single Resume Upload -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Single Resume Analysis</h5>
                    </div>
                    <div class="card-body">
                        <form id="singleUploadForm" enctype="multipart/form-data" action="javascript:void(0);">
                            <div class="mb-3">
                                <label for="resumeFile" class="form-label">Select Resume File</label>
                                <input type="file" class="form-control" id="resumeFile" name="file" accept=".pdf,.doc,.docx" required>
                                <div class="form-text">Supported formats: PDF, DOC, DOCX</div>
                            </div>

                            <div class="mb-3">
                                <label for="jobDescription" class="form-label">Job Description (Optional)</label>
                                <textarea class="form-control" id="jobDescription" name="job_description" rows="4" placeholder="Paste job description here for matching analysis..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload me-2"></i>Analyze Resume
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Batch Upload -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-files me-2"></i>Batch Resume Analysis</h5>
                    </div>
                    <div class="card-body">
                        <form id="batchUploadForm" enctype="multipart/form-data" action="javascript:void(0);">
                            <div class="mb-3">
                                <label for="resumeFiles" class="form-label">
                                    <i class="bi bi-folder2-open me-1"></i>
                                    Select Multiple Resume Files
                                </label>
                                <div class="drag-drop-area">
                                    <input type="file" class="form-control" id="resumeFiles" name="files" accept=".pdf,.doc,.docx" multiple required>
                                    <div class="drag-drop-overlay" id="dragDropOverlay">
                                        <div class="drag-drop-content">
                                            <i class="bi bi-cloud-upload"></i>
                                            <h5>Drop files here</h5>
                                            <p class="mb-0">Release to upload up to 50 files</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    You can select up to 50 files at once. Drag & drop supported.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="batchJobDescription" class="form-label">
                                    <i class="bi bi-file-text me-1"></i>
                                    Job Description (Optional)
                                </label>
                                <textarea class="form-control" id="batchJobDescription" name="job_description" rows="4" placeholder="Paste job description here to match all resumes..."></textarea>
                                <div class="form-text">Apply the same JD matching to all uploaded resumes</div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-cloud-upload me-2"></i>Analyze Multiple Resumes
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="previewFilesBtn">
                                    <i class="bi bi-eye me-2"></i>Preview Files
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Progress Tracking Section -->
                <div class="progress-section" id="progressSection">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-activity me-2"></i>Upload Progress</h5>
                        </div>
                        <div class="card-body">
                            <!-- Overall Progress -->
                            <div class="overall-progress">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h6 class="mb-1">Overall Progress</h6>
                                        <small id="progressStatus">Initializing upload...</small>
                                    </div>
                                    <div class="text-end">
                                        <h4 class="mb-0" id="overallPercentage">0%</h4>
                                        <small id="progressTime">0:00</small>
                                    </div>
                                </div>
                                <div class="overall-progress-bar">
                                    <div class="progress-bar" id="overallProgressBar" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Progress Stats -->
                            <div class="progress-header">
                                <div class="progress-stats">
                                    <div class="stat-item">
                                        <i class="bi bi-files"></i>
                                        <span id="totalFiles">0 files</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="bi bi-hourglass-split"></i>
                                        <span id="processingFiles">0 processing</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="bi bi-check-circle"></i>
                                        <span id="completedFiles">0 completed</span>
                                    </div>
                                    <div class="stat-item">
                                        <i class="bi bi-x-circle"></i>
                                        <span id="failedFiles">0 failed</span>
                                    </div>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-cancel btn-sm" id="cancelUploadBtn">
                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                    </button>
                                    <button class="btn btn-retry btn-sm" id="retryFailedBtn" style="display: none;">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Retry Failed
                                    </button>
                                </div>
                            </div>

                            <!-- Individual File Progress -->
                            <div id="fileProgressList" style="max-height: 400px; overflow-y: auto;">
                                <!-- File progress items will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Area -->
                <div id="results" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-check-circle me-2"></i>Analysis Results</h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-success btn-sm" id="exportResultsBtn">
                                    <i class="bi bi-download me-1"></i>Export Results
                                </button>
                                <button class="btn btn-outline-primary btn-sm" id="viewInSearchBtn">
                                    <i class="bi bi-search me-1"></i>View in Search
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loading" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing resume(s)... Please wait.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Drag and drop functionality (only if upload area exists)
        const uploadArea = document.querySelector('.upload-area');
        if (uploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('dragover');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('dragover');
            }
        }

        function getScoreColor(score) {
            if (score >= 80) return 'success';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        // Handle form submissions
        document.getElementById('singleUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            await submitAnalysis(formData, 'single');
        });

        document.getElementById('batchUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            await submitBatchAnalysisWithProgress(formData);
        });

        // Progress tracking state
        let uploadState = {
            files: [],
            startTime: null,
            completed: 0,
            failed: 0,
            processing: 0,
            cancelled: false,
            progressInterval: null
        };

        // Enhanced batch upload with progress tracking
        async function submitBatchAnalysisWithProgress(formData) {
            const files = formData.getAll('files');
            
            // Validate file count
            if (files.length > 50) {
                alert('Maximum 50 files allowed per batch upload.');
                return;
            }

            // Initialize progress tracking
            initializeProgressTracking(files);
            
            try {
                // Show progress section
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'none';

                // Process files with progress updates
                const results = await processBatchWithProgress(formData);
                
                // Stop the timer
                clearInterval(uploadState.progressInterval);
                
                // Format results for display
                const successfulResults = results.filter(r => !r.error);
                const errors = results.filter(r => r.error).map(r => `${r.filename}: ${r.error}`);
                
                const batchResult = {
                    total_processed: results.length,
                    successful: successfulResults.length,
                    failed: errors.length,
                    results: successfulResults,
                    errors: errors
                };
                
                // Show final results
                displayBatchResults(batchResult);
                
                // Hide progress section after a short delay to show completion
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    
                    // Scroll to results
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                }, 2000);
                
            } catch (error) {
                console.error('Batch upload error:', error);
                handleUploadError(error);
            }
        }

        function handleUploadError(error) {
            clearInterval(uploadState.progressInterval);
            
            // Show error in results section
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            let errorMessage = 'An unexpected error occurred during batch upload. Please try again.';
            if (error.message) {
                errorMessage = error.message;
            }
            
            document.getElementById('resultsContent').innerHTML = `
                <div class="alert alert-danger">
                    <h6 class="alert-heading">❌ Batch Upload Failed</h6>
                    <p class="mb-0">${errorMessage}</p>
                    <hr>
                    <small class="mb-0">
                        <strong>Troubleshooting tips:</strong><br>
                        • Ensure all files are valid PDF, DOC, or DOCX<br>
                        • Check total upload size is under 100MB<br>
                        • Make sure files are not password-protected<br>
                        • Try uploading smaller batches (10-20 files)<br>
                        • Check network connection and try again
                    </small>
                    <div class="mt-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Start Over
                        </button>
                    </div>
                </div>
            `;
        }

        function initializeProgressTracking(files) {
            uploadState = {
                files: files.map((file, index) => ({
                    id: `file-${index}`,
                    name: file.name,
                    size: formatFileSize(file.size),
                    status: 'pending',
                    progress: 0,
                    startTime: null,
                    endTime: null,
                    result: null,
                    error: null
                })),
                startTime: Date.now(),
                completed: 0,
                failed: 0,
                processing: 0,
                cancelled: false,
                progressInterval: null
            };

            // Update UI
            updateProgressStats();
            createFileProgressItems();
            startProgressTimer();
        }

        function createFileProgressItems() {
            const container = document.getElementById('fileProgressList');
            container.innerHTML = '';

            uploadState.files.forEach(file => {
                const fileElement = createFileProgressElement(file);
                container.appendChild(fileElement);
            });
        }

        function createFileProgressElement(file) {
            const template = `
                <div class="file-progress-item" data-file-id="${file.id}">
                    <div class="file-progress-header">
                        <div class="file-name" title="${file.name}">${file.name}</div>
                        <div class="file-status status-${file.status}">${getStatusLabel(file.status)}</div>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progress-${file.id}" 
                             style="width: ${file.progress}%">
                        </div>
                    </div>
                    <div class="file-details">
                        <div class="file-size">
                            <i class="bi bi-file-earmark"></i>
                            <span>${file.size}</span>
                        </div>
                        <div class="file-time">
                            <i class="bi bi-clock"></i>
                            <span id="time-${file.id}">0:00</span>
                        </div>
                    </div>
                    <div class="result-preview" id="preview-${file.id}" style="display: none;">
                        <div class="preview-score">
                            <span>Authenticity:</span>
                            <span class="score-badge score-high">-</span>
                            <span>Match:</span><span class="score-badge score-high">-</span>
                        </div>
                    </div>
                </div>
            `;

            const div = document.createElement('div');
            div.innerHTML = template;
            return div.firstElementChild;
        }

        async function processBatchWithProgress(formData) {
            const files = formData.getAll('files');
            const jobDescription = formData.get('job_description');
            const results = [];

            // Process files sequentially (can be parallelized in production)
            for (let i = 0; i < files.length; i++) {
                if (uploadState.cancelled) break;

                const file = files[i];
                const fileState = uploadState.files[i];
                
                // Update file status to processing
                updateFileStatus(fileState.id, 'processing');
                
                try {
                    // Create individual file form data
                    const fileFormData = new FormData();
                    fileFormData.append('file', file);
                    if (jobDescription) {
                        fileFormData.append('job_description', jobDescription);
                    }

                    // Simulate progress updates (in real implementation, this would come from WebSocket or polling)
                    await simulateFileProgress(fileState.id);

                    // Upload and analyze file
                    const response = await fetch('/api/scan-resume', {
                        method: 'POST',
                        body: fileFormData
                    });

                    if (!response.ok) {
                        throw new Error(`Upload failed: ${response.status}`);
                    }

                    const result = await response.json();
                    results.push(result);

                    // Update file status to completed
                    updateFileStatus(fileState.id, 'completed', result);

                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    updateFileStatus(fileState.id, 'failed', error);
                    results.push({ filename: file.name, error: error.message });
                }
            }

            return results;
        }

        async function simulateFileProgress(fileId) {
            // Simulate progress updates for demonstration
            // In production, this would be replaced with real progress updates
            const updateProgress = (progress) => {
                if (uploadState.cancelled) return;
                updateFileProgress(fileId, progress);
            };

            // Simulate processing steps
            const steps = [
                { progress: 25, delay: 200 },
                { progress: 50, delay: 400 },
                { progress: 75, delay: 300 },
                { progress: 90, delay: 200 },
                { progress: 100, delay: 100 }
            ];

            for (const step of steps) {
                await new Promise(resolve => setTimeout(resolve, step.delay));
                updateProgress(step.progress);
            }
        }

        function updateFileStatus(fileId, status, data = null) {
            const fileIndex = uploadState.files.findIndex(f => f.id === fileId);
            if (fileIndex === -1) return;

            const file = uploadState.files[fileIndex];
            
            // Update previous status counts
            if (file.status === 'processing') uploadState.processing--;
            if (file.status === 'completed') uploadState.completed--;
            if (file.status === 'failed') uploadState.failed--;

            // Update file status
            file.status = status;
            file.result = data;
            
            // Update new status counts
            if (status === 'processing') {
                uploadState.processing++;
                file.startTime = Date.now();
            }
            if (status === 'completed') {
                uploadState.completed++;
                file.endTime = Date.now();
                file.progress = 100;
                showFileResult(fileId, data);
            }
            if (status === 'failed') {
                uploadState.failed++;
                file.endTime = Date.now();
                file.error = data;
                file.progress = 0;
            }

            // Update UI
            updateFileProgressUI(fileId);
            updateProgressStats();
            updateOverallProgress();
        }

        function updateFileProgress(fileId, progress) {
            const fileIndex = uploadState.files.findIndex(f => f.id === fileId);
            if (fileIndex === -1) return;

            uploadState.files[fileIndex].progress = progress;
            updateFileProgressUI(fileId);
            updateOverallProgress();
        }

        function updateFileProgressUI(fileId) {
            const file = uploadState.files.find(f => f.id === fileId);
            if (!file) return;

            // Update progress bar
            const progressBar = document.getElementById(`progress-${fileId}`);
            if (progressBar) {
                progressBar.style.width = `${file.progress}%`;
                
                // Remove animation when complete
                if (file.progress === 100) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');
                } else if (file.status === 'failed') {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    progressBar.style.width = '100%';
                }
            }

            // Update status badge
            const statusElement = document.querySelector(`[data-file-id="${fileId}"] .file-status`);
            if (statusElement) {
                statusElement.className = `file-status status-${file.status}`;
                statusElement.textContent = getStatusLabel(file.status);
            }
        }

        function showFileResult(fileId, result) {
            const previewElement = document.getElementById(`preview-${fileId}`);
            if (!previewElement || !result) return;

            const authenticityScore = result.authenticity_score?.overall_score || 0;
            const matchScore = result.matching_score?.overall_match || 0;

            previewElement.innerHTML = `
                <div class="preview-score">
                    <span>Authenticity:</span>
                    <span class="score-badge ${getScoreClass(authenticityScore)}">${authenticityScore}%</span>
                    ${matchScore > 0 ? `
                        <span>Match:</span>
                        <span class="score-badge ${getScoreClass(matchScore)}">${matchScore}%</span>
                    ` : ''}
                </div>
            `;
            previewElement.style.display = 'block';
        }

        function updateProgressStats() {
            document.getElementById('totalFiles').textContent = `${uploadState.files.length} files`;
            document.getElementById('processingFiles').textContent = `${uploadState.processing} processing`;
            document.getElementById('completedFiles').textContent = `${uploadState.completed} completed`;
            document.getElementById('failedFiles').textContent = `${uploadState.failed} failed`;

            // Show/hide retry button
            const retryBtn = document.getElementById('retryFailedBtn');
            retryBtn.style.display = uploadState.failed > 0 ? 'block' : 'none';
        }

        function updateOverallProgress() {
            const totalFiles = uploadState.files.length;
            const totalProgress = uploadState.files.reduce((sum, file) => sum + file.progress, 0);
            const overallPercentage = totalFiles > 0 ? Math.round(totalProgress / totalFiles) : 0;

            // Update progress bar
            const progressBar = document.getElementById('overallProgressBar');
            if (progressBar) {
                progressBar.style.width = `${overallPercentage}%`;
            }

            // Update percentage text
            document.getElementById('overallPercentage').textContent = `${overallPercentage}%`;

            // Update status text
            let statusText = 'Processing files...';
            if (uploadState.cancelled) {
                statusText = 'Upload cancelled';
            } else if (uploadState.completed === totalFiles && uploadState.failed === 0) {
                statusText = 'All files completed successfully';
                // Stop progress bar animation when complete
                if (progressBar) {
                    progressBar.classList.remove('progress-bar-animated');
                }
            } else if (uploadState.completed + uploadState.failed === totalFiles) {
                statusText = `Processing complete (${uploadState.completed} successful, ${uploadState.failed} failed)`;
                // Stop progress bar animation when complete
                if (progressBar) {
                    progressBar.classList.remove('progress-bar-animated');
                }
            } else if (uploadState.processing > 0) {
                statusText = `Processing ${uploadState.processing} file${uploadState.processing > 1 ? 's' : ''}...`;
            }

            document.getElementById('progressStatus').textContent = statusText;
        }

        function startProgressTimer() {
            uploadState.progressInterval = setInterval(() => {
                updateElapsedTime();
            }, 1000);
        }

        function updateElapsedTime() {
            if (!uploadState.startTime) return;

            const elapsed = Date.now() - uploadState.startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('progressTime').textContent = timeString;

            // Update individual file times
            uploadState.files.forEach(file => {
                if (file.startTime && !file.endTime) {
                    const fileElapsed = Date.now() - file.startTime;
                    const fileMinutes = Math.floor(fileElapsed / 60000);
                    const fileSeconds = Math.floor((fileElapsed % 60000) / 1000);
                    const timeElement = document.getElementById(`time-${file.id}`);
                    if (timeElement) {
                        timeElement.textContent = `${fileMinutes}:${fileSeconds.toString().padStart(2, '0')}`;
                    }
                }
            });
        }

        // Helper functions
        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pending',
                'processing': 'Processing',
                'completed': 'Completed',
                'failed': 'Failed'
            };
            return labels[status] || status;
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-high';
            if (score >= 60) return 'score-medium';
            return 'score-low';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Event handlers
        document.getElementById('cancelUploadBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel the upload?')) {
                uploadState.cancelled = true;
                clearInterval(uploadState.progressInterval);
                
                // Update UI to show cancelled state
                document.getElementById('progressStatus').textContent = 'Upload cancelled';
                document.getElementById('overallProgressBar').classList.remove('progress-bar-animated');
                
                // Disable cancel button
                this.disabled = true;
            }
        });

        document.getElementById('retryFailedBtn').addEventListener('click', function() {
            // Retry failed files (implementation would depend on backend)
            alert('Retry functionality would be implemented with backend support');
        });

        // Drag and drop functionality
        const dragDropArea = document.querySelector('.drag-drop-area');
        const dragDropOverlay = document.getElementById('dragDropOverlay');
        const fileInput = document.getElementById('resumeFiles');

        if (dragDropArea && dragDropOverlay) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, () => {
                    dragDropOverlay.classList.add('active');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, () => {
                    dragDropOverlay.classList.remove('active');
                }, false);
            });

            dragDropArea.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                fileInput.files = files;
                updateFileList(files);
            });
        }

        function updateFileList(files) {
            if (files.length > 0) {
                const fileNames = Array.from(files).map(f => f.name).join(', ');
                const fileText = files.length === 1 ? '1 file selected' : `${files.length} files selected`;
                console.log(`${fileText}: ${fileNames}`);
            }
        }

        async function submitAnalysis(formData, type) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const endpoint = type === 'single' ? '/api/scan-resume' : '/api/batch-scan';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                // Handle HTTP errors
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }

                const result = await response.json();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                
                // Handle batch results differently
                if (type === 'batch') {
                    displayBatchResults(result);
                } else {
                    displaySingleResult(result);
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                
                let errorMessage = 'An unexpected error occurred. Please try again.';
                if (error.message) {
                    errorMessage = error.message;
                }
                
                document.getElementById('resultsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">❌ Upload Failed</h6>
                        <p class="mb-0">${errorMessage}</p>
                        <hr>
                        <small class="mb-0">
                            <strong>Troubleshooting tips:</strong><br>
                            • Ensure file is a valid PDF, DOC, or DOCX<br>
                            • Check file size is under 10MB<br>
                            • Make sure file is not password-protected<br>
                            • Try a different file if problem persists
                        </small>
                    </div>
                `;
                document.getElementById('results').style.display = 'block';
            }
        }

        function displaySingleResult(result) {
            const diagnostics = result.authenticity_score?.diagnostics || {};
            
            // Debug: Log the diagnostics to console
            console.log('Diagnostics data:', diagnostics);
            console.log('Full result:', result);
            
            document.getElementById('resultsContent').innerHTML = `
                <h6>Analysis Complete</h6>
                <div class="row">
                        <div class="col-md-6">
                            <h6>📊 Authenticity Score</h6>
                            <div class="mb-3">
                                <div class="progress">
                                    <div class="progress-bar bg-${getScoreColor(result.authenticity_score?.overall_score || 0)}"
                                         role="progressbar"
                                         style="width: ${result.authenticity_score?.overall_score || 0}%">
                                        ${Math.round(result.authenticity_score?.overall_score || 0)}%
                                    </div>
                                </div>
                            </div>
                            <div class="row text-sm">
                                <div class="col-6">
                                    <small><strong>Font Consistency:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.font_consistency || 0)}">${Math.round(result.authenticity_score?.font_consistency || 0)}%</span>
                                </div>
                                <div class="col-6">
                                    <small><strong>Grammar Quality:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.grammar_score || 0)}">${Math.round(result.authenticity_score?.grammar_score || 0)}%</span>
                                </div>
                            </div>
                            <div class="row text-sm mt-2">
                                <div class="col-6">
                                    <small><strong>Formatting:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.formatting_score || 0)}">${Math.round(result.authenticity_score?.formatting_score || 0)}%</span>
                                </div>
                                <div class="col-6">
                                    <small><strong>Structure:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.visual_consistency || 0)}">${Math.round(result.authenticity_score?.visual_consistency || 0)}%</span>
                                </div>
                            </div>
                            <div class="row text-sm mt-2">
                                <div class="col-6">
                                    <small><strong>LinkedIn Profile:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.linkedin_profile_score || 0)}">${Math.round(result.authenticity_score?.linkedin_profile_score || 0)}%</span>
                                </div>
                                <div class="col-6">
                                    <small><strong>Capitalization:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.capitalization_score || 0)}">${Math.round(result.authenticity_score?.capitalization_score || 0)}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>📋 Analysis Details</h6>
                            <p><strong>File:</strong> ${result.filename}</p>
                            <p><strong>File Size:</strong> ${(result.file_size / 1024).toFixed(1)} KB</p>
                            
                            ${result.authenticity_score?.flags && result.authenticity_score.flags.length > 0 ? `
                                <div class="mt-3">
                                    <h6>🚩 Flags</h6>
                                    ${result.authenticity_score.flags.map(flag => `
                                        <div class="alert alert-${flag.severity === 'high' ? 'danger' : flag.severity === 'medium' ? 'warning' : 'info'} py-2 mb-2">
                                            <small>
                                                <strong>${flag.category}:</strong> ${flag.message}
                                            </small>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${result.matching_score ? `
                                <div class="mt-3">
                                    <h6>🎯 JD Match: ${Math.round(result.matching_score.overall_match)}%</h6>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-${getScoreColor(result.matching_score.overall_match)}"
                                             style="width: ${result.matching_score.overall_match}%">
                                            ${Math.round(result.matching_score.overall_match)}%
                                        </div>
                                    </div>
                                    <div class="text-sm">
                                        <div class="row mb-2">
                                            <div class="col-4"><small><strong>Skills:</strong></small></div>
                                            <div class="col-8">
                                                <span class="badge bg-${getScoreColor(result.matching_score.skills_match)}">${Math.round(result.matching_score.skills_match)}%</span>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><small><strong>Experience:</strong></small></div>
                                            <div class="col-8">
                                                <span class="badge bg-${getScoreColor(result.matching_score.experience_match)}">${Math.round(result.matching_score.experience_match)}%</span>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><small><strong>Education:</strong></small></div>
                                            <div class="col-8">
                                                <span class="badge bg-${getScoreColor(result.matching_score.education_match)}">${Math.round(result.matching_score.education_match)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    ${result.matching_score.missing_skills && result.matching_score.missing_skills.length > 0 ? `
                                        <div class="mt-2">
                                            <small class="text-warning">
                                                <strong>✗ Missing Skills:</strong> ${result.matching_score.missing_skills.slice(0, 5).join(', ')}${result.matching_score.missing_skills.length > 5 ? '...' : ''}
                                            </small>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="mt-3">
                                <small class="text-muted">${(result.authenticity_score?.details || []).join('<br>')}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Diagnostics Button -->
                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detailedDiagnostics">
                            🔍 View Detailed Diagnostics
                        </button>
                    </div>
                    
                    <!-- Detailed Diagnostics Collapse -->
                    <div class="collapse mt-3" id="detailedDiagnostics">
                        <div class="card card-body">
                            ${generateDiagnosticsHTML(diagnostics, result.matching_score)}
                        </div>
                    </div>
                `;
        }
        
        function generateDiagnosticsHTML(diagnostics, matchingScore = null) {
            let html = '<h6 class="mb-3">📋 Detailed Analysis Report</h6>';
            
            // JD Matching Diagnostics (if available)
            if (matchingScore) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">🎯 Job Description Matching Analysis</h6>
                        <div class="alert alert-${getScoreColor(matchingScore.overall_match) === 'success' ? 'success' : getScoreColor(matchingScore.overall_match) === 'warning' ? 'warning' : 'danger'}">
                            <h6 class="alert-heading">Overall Match: ${Math.round(matchingScore.overall_match)}%</h6>
                            <hr>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Skills Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.skills_match)}" 
                                             style="width: ${matchingScore.skills_match}%">
                                            ${Math.round(matchingScore.skills_match)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Experience Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.experience_match)}" 
                                             style="width: ${matchingScore.experience_match}%">
                                            ${Math.round(matchingScore.experience_match)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Education Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.education_match)}" 
                                             style="width: ${matchingScore.education_match}%">
                                            ${Math.round(matchingScore.education_match)}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${matchingScore.matched_skills && matchingScore.matched_skills.length > 0 ? `
                                <div class="mb-3">
                                    <p class="mb-2"><strong>✓ Matched Skills (${matchingScore.matched_skills.length}):</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${matchingScore.matched_skills.map(skill => `
                                            <span class="badge bg-success">${skill}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '<p class="mb-2 text-muted">No skills matched from the job description.</p>'}
                            
                            ${matchingScore.missing_skills && matchingScore.missing_skills.length > 0 ? `
                                <div class="mb-3">
                                    <p class="mb-2"><strong>✗ Missing Skills (${matchingScore.missing_skills.length}):</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${matchingScore.missing_skills.map(skill => `
                                            <span class="badge bg-danger">${skill}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${matchingScore.details && matchingScore.details.length > 0 ? `
                                <div class="mt-3">
                                    <p class="mb-2"><strong>📝 Detailed Feedback:</strong></p>
                                    <ul class="mb-0">
                                        ${matchingScore.details.map(detail => `<li>${detail}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 p-2 bg-light rounded">
                                <small class="text-muted">
                                    <strong>💡 Matching Algorithm:</strong> This score is calculated based on weighted factors: 
                                    Skills (50%), Experience (30%), and Education (20%). The algorithm uses keyword matching 
                                    and considers both required and bonus qualifications.
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Debug: Check if diagnostics exists
            if (!diagnostics || Object.keys(diagnostics).length === 0) {
                if (!matchingScore) {
                    html += `
                        <div class="alert alert-warning">
                            <p class="mb-0">⚠️ Detailed diagnostics are not available for this resume.</p>
                            <small>This may occur with older analysis results or if the document format is not fully supported.</small>
                        </div>
                    `;
                }
                return html;
            }
            
            html += '<h6 class="text-primary mb-3">🔍 Authenticity Analysis Details</h6>';
            
            // LinkedIn Diagnostics - Enhanced with separate Resume/Online sections
            if (diagnostics.linkedin) {
                html += `<div class="mb-4"><h6 class="text-primary">🔗 Professional Profile Analysis</h6>`;
                
                // Section 1: Resume Presence
                if (diagnostics.linkedin.profile) {
                    const profile = diagnostics.linkedin.profile;
                    const resumeStatus = profile.cross_verified ? 'success' : 'warning';
                    html += `
                        <div class="alert alert-${resumeStatus} mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">📄</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Found in Resume</strong></p>
                                    <p class="mb-1">
                                        <strong>LinkedIn URL:</strong> 
                                        <a href="${profile.url}" target="_blank" class="text-decoration-none">
                                            ${profile.url}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16" style="margin-left: 4px;">
                                                <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                                                <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                                            </svg>
                                        </a>
                                    </p>
                                    <p class="mb-0"><strong>Username:</strong> <code>${profile.username}</code></p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (diagnostics.linkedin.verification_details) {
                    // Show "Not Found in Resume" when we have online verification but no resume profile
                    html += `
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">📄</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Not Found in Resume</strong></p>
                                    <p class="mb-0"><small>No LinkedIn URL detected in the resume. However, we found a profile through online search (see below).</small></p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Section 2: Online Verification (Enhanced)
                if (diagnostics.linkedin.verification_details) {
                    const details = diagnostics.linkedin.verification_details;
                    html += `
                        <div class="alert alert-info mb-3" style="border-left: 4px solid #0077b5;">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">🔍</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Online Verification Results</strong></p>
                                    <div class="mb-2">
                                        <span class="badge bg-success me-2">✓ Verified</span>
                                        <span class="badge bg-info">via ${details.search_engine}</span>
                                    </div>
                                    
                                    ${details.search_url ? `
                                        <p class="mb-2">
                                            <strong>Verification Source:</strong><br>
                                            <a href="${details.search_url}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16" style="margin-right: 4px;">
                                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                                </svg>
                                                View ${details.search_engine} Search: "${details.search_query}"
                                            </a>
                                        </p>
                                    ` : ''}
                                    
                                    ${details.matched_profiles && details.matched_profiles.length > 0 ? `
                                        <div class="mt-2">
                                            <strong>Matched LinkedIn Profile(s):</strong>
                                            <ul class="list-unstyled mt-1 mb-0">
                                                ${details.matched_profiles.slice(0, 3).map(profile => {
                                                    // Add https:// if not present
                                                    const profileUrl = profile.startsWith('http') ? profile : 'https://' + profile;
                                                    return `
                                                    <li class="mb-1">
                                                        <a href="${profileUrl}" target="_blank" class="text-decoration-none">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#0077b5" class="bi bi-linkedin" viewBox="0 0 16 16">
                                                                <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/>
                                                            </svg>
                                                            ${profile}
                                                        </a>
                                                    </li>
                                                `}).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="mt-2 p-2 bg-light rounded">
                                        <small class="text-muted">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                            </svg>
                                            <strong>Why this matters:</strong> HR can click the verification link to confirm this is the correct person and not someone with a similar name.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (diagnostics.linkedin.profile && diagnostics.linkedin.profile.cross_verified === false) {
                    // Show warning if found in resume but not verified
                    html += `
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">⚠️</span>
                                <div style="flex: 1;">
                                    <p class="mb-1"><strong>Could Not Verify Online</strong></p>
                                    <small>The LinkedIn profile from the resume could not be found through online search. This may indicate a deleted profile or privacy settings.</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Alternative Profiles
                if (diagnostics.linkedin.alternatives && diagnostics.linkedin.alternatives.length > 0) {
                    html += `
                        <div class="alert alert-secondary mb-3">
                            <p class="mb-2"><strong>Alternative Profiles Found:</strong></p>
                            <ul class="mb-0">
                                ${diagnostics.linkedin.alternatives.map(alt => `
                                    <li>
                                        <strong>${alt.platform}:</strong> 
                                        <a href="${alt.url}" target="_blank" class="text-decoration-none">
                                            ${alt.url}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 2px;">
                                                <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                                                <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                                            </svg>
                                        </a>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            // Capitalization Diagnostics
            if (diagnostics.capitalization) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">✍️ Capitalization Analysis</h6>
                        <p><strong>Issues Found:</strong> ${diagnostics.capitalization.issues_found}</p>
                        ${diagnostics.capitalization.details.map(issue => `
                            <div class="alert alert-${issue.severity === 'high' ? 'danger' : issue.severity === 'medium' ? 'warning' : 'info'} mb-2">
                                <h6 class="alert-heading">${issue.type}</h6>
                                ${issue.message ? `<p class="mb-0">${issue.message}</p>` : ''}
                                ${issue.count ? `<p class="mb-1"><strong>Count:</strong> ${issue.count} occurrences</p>` : ''}
                                ${issue.examples ? `
                                    <p class="mb-1"><strong>Examples:</strong></p>
                                    ${Array.isArray(issue.examples) ? `
                                        <ul class="mb-1">
                                            ${issue.examples.map(ex => `<li><code>${typeof ex === 'object' ? JSON.stringify(ex) : ex}</code></li>`).join('')}
                                        </ul>
                                    ` : `<code>${JSON.stringify(issue.examples)}</code>`}
                                ` : ''}
                                ${issue.fix ? `<p class="mb-0"><strong>💡 Fix:</strong> ${issue.fix}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Font Diagnostics
            if (diagnostics.fonts) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">🔤 Font Usage Analysis</h6>
                        <div class="alert alert-info">
                            <p class="mb-2"><strong>${diagnostics.fonts.recommendation}</strong></p>
                            <p class="mb-1"><strong>Total Unique Fonts:</strong> ${diagnostics.fonts.total_unique_fonts}</p>
                            ${diagnostics.fonts.fonts_breakdown && Object.keys(diagnostics.fonts.fonts_breakdown).length > 0 ? `
                                <p class="mb-1"><strong>Font Breakdown:</strong></p>
                                <ul class="mb-0">
                                    ${Object.entries(diagnostics.fonts.fonts_breakdown).map(([font, count]) => `
                                        <li><strong>${font}:</strong> ${count} ${typeof count === 'number' ? 'times' : ''}</li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Grammar Diagnostics
            if (diagnostics.grammar) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">📝 Grammar & Content Analysis</h6>
                        <p><strong>Issues Found:</strong> ${diagnostics.grammar.issues_found}</p>
                        ${diagnostics.grammar.details.map(issue => `
                            <div class="alert alert-${issue.severity === 'high' ? 'danger' : issue.severity === 'medium' ? 'warning' : 'info'} mb-2">
                                <h6 class="alert-heading">${issue.type}</h6>
                                ${issue.message ? `<p class="mb-0">${issue.message}</p>` : ''}
                                ${issue.count ? `<p class="mb-1"><strong>Count:</strong> ${issue.count} occurrences</p>` : ''}
                                ${issue.examples ? `
                                    <p class="mb-1"><strong>Examples:</strong></p>
                                    <ul class="mb-1">
                                        ${issue.examples.map(ex => `<li><code>${ex}</code></li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${issue.fix ? `<p class="mb-0"><strong>💡 Fix:</strong> ${issue.fix}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return html;
        }

        function displayBatchResults(batchResult) {
            const { total_processed, successful, failed, results, errors } = batchResult;
            
            let html = `
                <h6>Batch Analysis Complete</h6>
                <div class="alert alert-info mb-3">
                    <strong>Summary:</strong> Processed ${total_processed} files | 
                    ✓ ${successful} successful | 
                    ${failed > 0 ? `✗ ${failed} failed` : 'All successful'}
                </div>
            `;

            // Display errors if any
            if (errors && errors.length > 0) {
                html += `
                    <div class="alert alert-warning mb-3">
                        <h6 class="alert-heading">⚠️ Some files failed:</h6>
                        <ul class="mb-0">
                            ${errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Display successful results
            if (results && results.length > 0) {
                html += `<div class="accordion" id="batchResultsAccordion">`;
                
                results.forEach((result, index) => {
                    const avgScore = result.authenticity_score?.overall_score || 0;
                    const scoreColor = avgScore >= 80 ? 'success' : avgScore >= 60 ? 'warning' : 'danger';
                    
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                    <span class="badge bg-${scoreColor} me-2">${Math.round(avgScore)}%</span>
                                    ${result.filename}
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                 data-bs-parent="#batchResultsAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>📊 Authenticity Scores</h6>
                                            <p><strong>Overall:</strong> ${Math.round(result.authenticity_score?.overall_score || 0)}%</p>
                                            <p><strong>Font:</strong> ${Math.round(result.authenticity_score?.font_consistency || 0)}%</p>
                                            <p><strong>Grammar:</strong> ${Math.round(result.authenticity_score?.grammar_score || 0)}%</p>
                                            <p><strong>Formatting:</strong> ${Math.round(result.authenticity_score?.formatting_score || 0)}%</p>
                                            <p><strong>LinkedIn:</strong> ${Math.round(result.authenticity_score?.linkedin_profile_score || 0)}%</p>
                                            <p><strong>Capitalization:</strong> ${Math.round(result.authenticity_score?.capitalization_score || 0)}%</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>📋 Details</h6>
                                            <p><strong>Size:</strong> ${(result.file_size / 1024).toFixed(1)} KB</p>
                                            
                                            ${result.matching_score ? `
                                                <div class="mt-2">
                                                    <h6>🎯 JD Match: ${Math.round(result.matching_score.overall_match)}%</h6>
                                                    <div class="progress mb-2" style="height: 20px;">
                                                        <div class="progress-bar bg-${getScoreColor(result.matching_score.overall_match)}"
                                                             style="width: ${result.matching_score.overall_match}%">
                                                            ${Math.round(result.matching_score.overall_match)}%
                                                        </div>
                                                    </div>
                                                    <small>
                                                        Skills: ${Math.round(result.matching_score.skills_match)}% | 
                                                        Experience: ${Math.round(result.matching_score.experience_match)}% | 
                                                        Education: ${Math.round(result.matching_score.education_match)}%
                                                    </small>
                                                </div>
                                            ` : ''}
                                            
                                            ${result.authenticity_score?.flags && result.authenticity_score.flags.length > 0 ? `
                                                <div class="mt-3">
                                                    <strong>🚩 Flags:</strong>
                                                    <ul class="list-unstyled mb-0 mt-1">
                                                        ${result.authenticity_score.flags.map(flag => `
                                                            <li class="mb-1">
                                                                <span class="badge bg-${flag.severity === 'high' ? 'danger' : flag.severity === 'medium' ? 'warning' : 'info'}" 
                                                                      style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                                                    ${flag.severity === 'high' ? '🔴' : flag.severity === 'medium' ? '🟡' : 'ℹ️'}
                                                                </span>
                                                                <span style="font-size: 0.875rem;">${flag.message}</span>
                                                            </li>
                                                        `).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            
                                            <div class="mt-2">
                                                <small class="text-muted">${(result.authenticity_score?.details || []).join('<br>')}</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Detailed Diagnostics Button for Batch Item -->
                                    <div class="mt-3 text-center">
                                        <button class="btn btn-outline-primary btn-sm" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#batchDiagnostics${index}">
                                            🔍 View Detailed Diagnostics
                                        </button>
                                    </div>
                                    
                                    <!-- Detailed Diagnostics Collapse for Batch Item -->
                                    <div class="collapse mt-3" id="batchDiagnostics${index}">
                                        <div class="card card-body">
                                            ${generateDiagnosticsHTML(result.authenticity_score?.diagnostics || {}, result.matching_score)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }

            document.getElementById('resultsContent').innerHTML = html;
        }
    </script>
</body>
</html>
