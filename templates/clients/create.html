<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Client - HR Recruitment System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .required::after {
            content: " *";
            color: red;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .contact-item {
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            background: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">HR Recruitment System</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/jobs">Jobs</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/clients">Clients</a></li>
                    <li class="nav-item"><a class="nav-link" href="/users">Users</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-building"></i> Create New Client</h1>
            <a href="/clients" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>

        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Fields marked with <span class="text-danger">*</span> are required.
        </div>

        <form id="clientForm">
            <!-- Basic Information -->
            <div class="form-section">
                <h4 class="mb-3"><i class="fas fa-info-circle"></i> Basic Information</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label required">Client Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="industry" class="form-label">Industry</label>
                        <select class="form-select" id="industry" name="industry">
                            <option value="">Select Industry</option>
                            <option value="Technology">Technology</option>
                            <option value="Finance">Finance</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Retail">Retail</option>
                            <option value="Education">Education</option>
                            <option value="Consulting">Consulting</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="website" class="form-label">Website</label>
                        <input type="url" class="form-control" id="website" name="website" placeholder="https://example.com">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="account_manager_id" class="form-label required">Account Manager</label>
                        <select class="form-select" id="account_manager_id" name="account_manager_id" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="form-section">
                <h4 class="mb-3"><i class="fas fa-map-marker-alt"></i> Address Information</h4>
                <div class="mb-3">
                    <label for="address" class="form-label">Street Address</label>
                    <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="city" class="form-label">City</label>
                        <input type="text" class="form-control" id="city" name="city">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="state" class="form-label">State/Province</label>
                        <input type="text" class="form-control" id="state" name="state">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="country" class="form-label">Country</label>
                        <input type="text" class="form-control" id="country" name="country">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="postal_code" class="form-label">Postal Code</label>
                        <input type="text" class="form-control" id="postal_code" name="postal_code">
                    </div>
                </div>
            </div>

            <!-- Contact Persons -->
            <div class="form-section">
                <h4 class="mb-3"><i class="fas fa-users"></i> Contact Persons <span class="text-danger">*</span></h4>
                <div id="contactsContainer">
                    <!-- Contacts will be added here -->
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addContact()">
                    <i class="fas fa-plus"></i> Add Contact
                </button>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-end gap-2 mb-5">
                <a href="/clients" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Create Client
                </button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let contactIndex = 0;

        // Load account managers
        async function loadAccountManagers() {
            try {
                // For now, we'll need to get users with manager/admin role
                // This would come from a proper API endpoint
                const managerSelect = document.getElementById('account_manager_id');
                managerSelect.innerHTML = '<option value="">Select Account Manager</option>';
                
                // Placeholder - in production, fetch from /api/users?role=manager,admin
                managerSelect.innerHTML += '<option value="temp-manager-id">Demo Manager</option>';
            } catch (error) {
                console.error('Error loading account managers:', error);
            }
        }

        function addContact(isFirst = false) {
            const container = document.getElementById('contactsContainer');
            const contactId = `contact-${contactIndex++}`;
            
            const contactHTML = `
                <div class="contact-item" id="${contactId}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>Contact Person ${contactIndex}</h6>
                        ${!isFirst ? `<button type="button" class="btn btn-sm btn-danger" onclick="removeContact('${contactId}')">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label required">Full Name</label>
                            <input type="text" class="form-control contact-name" required>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control contact-title">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label required">Email</label>
                            <input type="email" class="form-control contact-email" required>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control contact-phone">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Mobile</label>
                            <input type="tel" class="form-control contact-mobile">
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input contact-primary" type="checkbox" ${isFirst ? 'checked' : ''} 
                               onchange="handlePrimaryContact(this)">
                        <label class="form-check-label">Primary Contact</label>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', contactHTML);
        }

        function removeContact(contactId) {
            document.getElementById(contactId).remove();
        }

        function handlePrimaryContact(checkbox) {
            if (checkbox.checked) {
                // Uncheck other primary contacts
                document.querySelectorAll('.contact-primary').forEach(cb => {
                    if (cb !== checkbox) cb.checked = false;
                });
            }
        }

        function getContacts() {
            const contacts = [];
            document.querySelectorAll('.contact-item').forEach(item => {
                const contact = {
                    full_name: item.querySelector('.contact-name').value,
                    title: item.querySelector('.contact-title').value || null,
                    email: item.querySelector('.contact-email').value,
                    phone: item.querySelector('.contact-phone').value || null,
                    mobile: item.querySelector('.contact-mobile').value || null,
                    is_primary: item.querySelector('.contact-primary').checked
                };
                contacts.push(contact);
            });
            return contacts;
        }

        // Handle form submission
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const contacts = getContacts();
            if (contacts.length === 0) {
                alert('Please add at least one contact person');
                return;
            }

            // Ensure at least one primary contact
            const hasPrimary = contacts.some(c => c.is_primary);
            if (!hasPrimary) {
                contacts[0].is_primary = true;
            }

            const formData = {
                name: document.getElementById('name').value,
                industry: document.getElementById('industry').value || null,
                website: document.getElementById('website').value || null,
                address: document.getElementById('address').value || null,
                city: document.getElementById('city').value || null,
                state: document.getElementById('state').value || null,
                country: document.getElementById('country').value || null,
                postal_code: document.getElementById('postal_code').value || null,
                account_manager_id: document.getElementById('account_manager_id').value,
                contacts: contacts
            };

            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create client');
                }

                const result = await response.json();
                alert('Client created successfully!');
                window.location.href = `/clients/${result.id}`;
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating client: ' + error.message);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAccountManagers();
            addContact(true); // Add first contact
        });
    </script>
</body>
</html>
