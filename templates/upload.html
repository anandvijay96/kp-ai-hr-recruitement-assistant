<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Resume - AI HR Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }
        .badge {
            font-size: 0.75em;
        }
        .text-sm {
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">ü§ñ AI HR Assistant</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/upload">Resume Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/candidates">Candidate Database</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="text-center mb-4">Upload Resume for Analysis</h2>

                <!-- Single Resume Upload -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Single Resume Analysis</h5>
                    </div>
                    <div class="card-body">
                        <form id="singleUploadForm" enctype="multipart/form-data" action="javascript:void(0);">
                            <div class="mb-3">
                                <label for="resumeFile" class="form-label">Select Resume File</label>
                                <input type="file" class="form-control" id="resumeFile" name="file" accept=".pdf,.doc,.docx" required>
                                <div class="form-text">Supported formats: PDF, DOC, DOCX</div>
                            </div>

                            <div class="mb-3">
                                <label for="jobDescription" class="form-label">Job Description (Optional)</label>
                                <textarea class="form-control" id="jobDescription" name="job_description" rows="4" placeholder="Paste job description here for matching analysis..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">Analyze Resume</button>
                        </form>
                    </div>
                </div>

                <!-- Batch Upload -->
                <div class="card">
                    <div class="card-header">
                        <h5>Batch Resume Analysis</h5>
                    </div>
                    <div class="card-body">
                        <form id="batchUploadForm" enctype="multipart/form-data" action="javascript:void(0);">
                            <div class="mb-3">
                                <label for="resumeFiles" class="form-label">Select Multiple Resume Files</label>
                                <input type="file" class="form-control" id="resumeFiles" name="files" accept=".pdf,.doc,.docx" multiple required>
                                <div class="form-text">You can select multiple files at once</div>
                            </div>

                            <div class="mb-3">
                                <label for="batchJobDescription" class="form-label">Job Description (Optional)</label>
                                <textarea class="form-control" id="batchJobDescription" name="job_description" rows="4" placeholder="Paste job description here to match all resumes..."></textarea>
                                <div class="form-text">Apply the same JD matching to all uploaded resumes</div>
                            </div>

                            <button type="submit" class="btn btn-secondary">Analyze Multiple Resumes</button>
                        </form>
                    </div>
                </div>

                <!-- Results Area -->
                <div id="results" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5>Analysis Results</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loading" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing resume(s)... Please wait.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Drag and drop functionality (only if upload area exists)
        const uploadArea = document.querySelector('.upload-area');
        if (uploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('dragover');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('dragover');
            }
        }

        function getScoreColor(score) {
            if (score >= 80) return 'success';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        // Handle form submissions
        document.getElementById('singleUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            await submitAnalysis(formData, 'single');
        });

        document.getElementById('batchUploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            await submitAnalysis(formData, 'batch');
        });

        async function submitAnalysis(formData, type) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const endpoint = type === 'single' ? '/api/scan-resume' : '/api/batch-scan';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                // Handle HTTP errors
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }

                const result = await response.json();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                
                // Handle batch results differently
                if (type === 'batch') {
                    displayBatchResults(result);
                } else {
                    displaySingleResult(result);
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                
                let errorMessage = 'An unexpected error occurred. Please try again.';
                if (error.message) {
                    errorMessage = error.message;
                }
                
                document.getElementById('resultsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">‚ùå Upload Failed</h6>
                        <p class="mb-0">${errorMessage}</p>
                        <hr>
                        <small class="mb-0">
                            <strong>Troubleshooting tips:</strong><br>
                            ‚Ä¢ Ensure file is a valid PDF, DOC, or DOCX<br>
                            ‚Ä¢ Check file size is under 10MB<br>
                            ‚Ä¢ Make sure file is not password-protected<br>
                            ‚Ä¢ Try a different file if problem persists
                        </small>
                    </div>
                `;
                document.getElementById('results').style.display = 'block';
            }
        }

        function displaySingleResult(result) {
            const diagnostics = result.authenticity_score?.diagnostics || {};
            
            // Debug: Log the diagnostics to console
            console.log('Diagnostics data:', diagnostics);
            console.log('Full result:', result);
            
            document.getElementById('resultsContent').innerHTML = `
                <h6>Analysis Complete</h6>
                <div class="row">
                        <div class="col-md-6">
                            <h6>üìä Authenticity Score</h6>
                            <div class="mb-3">
                                <div class="progress">
                                    <div class="progress-bar bg-${getScoreColor(result.authenticity_score?.overall_score || 0)}"
                                         role="progressbar"
                                         style="width: ${result.authenticity_score?.overall_score || 0}%">
                                        ${Math.round(result.authenticity_score?.overall_score || 0)}%
                                    </div>
                                </div>
                            </div>
                            <div class="row text-sm">
                                <div class="col-6">
                                    <small><strong>Font Consistency:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.font_consistency || 0)}">${Math.round(result.authenticity_score?.font_consistency || 0)}%</span>
                                </div>
                                <div class="col-6">
                                    <small><strong>Grammar Quality:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.grammar_score || 0)}">${Math.round(result.authenticity_score?.grammar_score || 0)}%</span>
                                </div>
                            </div>
                            <div class="row text-sm mt-2">
                                <div class="col-6">
                                    <small><strong>Formatting:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.formatting_score || 0)}">${Math.round(result.authenticity_score?.formatting_score || 0)}%</span>
                                </div>
                                <div class="col-6">
                                    <small><strong>Structure:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.visual_consistency || 0)}">${Math.round(result.authenticity_score?.visual_consistency || 0)}%</span>
                                </div>
                            </div>
                            <div class="row text-sm mt-2">
                                <div class="col-6">
                                    <small><strong>LinkedIn Profile:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.linkedin_profile_score || 0)}">${Math.round(result.authenticity_score?.linkedin_profile_score || 0)}%</span>
                                </div>
                                <div class="col-6">
                                    <small><strong>Capitalization:</strong></small><br>
                                    <span class="badge bg-${getScoreColor(result.authenticity_score?.capitalization_score || 0)}">${Math.round(result.authenticity_score?.capitalization_score || 0)}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>üìã Analysis Details</h6>
                            <p><strong>File:</strong> ${result.filename}</p>
                            <p><strong>File Size:</strong> ${(result.file_size / 1024).toFixed(1)} KB</p>
                            
                            ${result.authenticity_score?.flags && result.authenticity_score.flags.length > 0 ? `
                                <div class="mt-3">
                                    <h6>üö© Flags</h6>
                                    ${result.authenticity_score.flags.map(flag => `
                                        <div class="alert alert-${flag.severity === 'high' ? 'danger' : flag.severity === 'medium' ? 'warning' : 'info'} py-2 mb-2">
                                            <small>
                                                <strong>${flag.category}:</strong> ${flag.message}
                                            </small>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${result.matching_score ? `
                                <div class="mt-3">
                                    <h6>üéØ JD Match: ${Math.round(result.matching_score.overall_match)}%</h6>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-${getScoreColor(result.matching_score.overall_match)}"
                                             style="width: ${result.matching_score.overall_match}%">
                                            ${Math.round(result.matching_score.overall_match)}%
                                        </div>
                                    </div>
                                    <div class="text-sm">
                                        <div class="row mb-2">
                                            <div class="col-4"><small><strong>Skills:</strong></small></div>
                                            <div class="col-8">
                                                <span class="badge bg-${getScoreColor(result.matching_score.skills_match)}">${Math.round(result.matching_score.skills_match)}%</span>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><small><strong>Experience:</strong></small></div>
                                            <div class="col-8">
                                                <span class="badge bg-${getScoreColor(result.matching_score.experience_match)}">${Math.round(result.matching_score.experience_match)}%</span>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><small><strong>Education:</strong></small></div>
                                            <div class="col-8">
                                                <span class="badge bg-${getScoreColor(result.matching_score.education_match)}">${Math.round(result.matching_score.education_match)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    ${result.matching_score.missing_skills && result.matching_score.missing_skills.length > 0 ? `
                                        <div class="mt-2">
                                            <small class="text-warning">
                                                <strong>‚úó Missing Skills:</strong> ${result.matching_score.missing_skills.slice(0, 5).join(', ')}${result.matching_score.missing_skills.length > 5 ? '...' : ''}
                                            </small>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="mt-3">
                                <small class="text-muted">${(result.authenticity_score?.details || []).join('<br>')}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Diagnostics Button -->
                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detailedDiagnostics">
                            üîç View Detailed Diagnostics
                        </button>
                    </div>
                    
                    <!-- Detailed Diagnostics Collapse -->
                    <div class="collapse mt-3" id="detailedDiagnostics">
                        <div class="card card-body">
                            ${generateDiagnosticsHTML(diagnostics, result.matching_score)}
                        </div>
                    </div>
                `;
        }
        
        function generateDiagnosticsHTML(diagnostics, matchingScore = null) {
            let html = '<h6 class="mb-3">üìã Detailed Analysis Report</h6>';
            
            // JD Matching Diagnostics (if available)
            if (matchingScore) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">üéØ Job Description Matching Analysis</h6>
                        <div class="alert alert-${getScoreColor(matchingScore.overall_match) === 'success' ? 'success' : getScoreColor(matchingScore.overall_match) === 'warning' ? 'warning' : 'danger'}">
                            <h6 class="alert-heading">Overall Match: ${Math.round(matchingScore.overall_match)}%</h6>
                            <hr>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Skills Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.skills_match)}" 
                                             style="width: ${matchingScore.skills_match}%">
                                            ${Math.round(matchingScore.skills_match)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Experience Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.experience_match)}" 
                                             style="width: ${matchingScore.experience_match}%">
                                            ${Math.round(matchingScore.experience_match)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2"><strong>Education Match:</strong></p>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-${getScoreColor(matchingScore.education_match)}" 
                                             style="width: ${matchingScore.education_match}%">
                                            ${Math.round(matchingScore.education_match)}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${matchingScore.matched_skills && matchingScore.matched_skills.length > 0 ? `
                                <div class="mb-3">
                                    <p class="mb-2"><strong>‚úì Matched Skills (${matchingScore.matched_skills.length}):</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${matchingScore.matched_skills.map(skill => `
                                            <span class="badge bg-success">${skill}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '<p class="mb-2 text-muted">No skills matched from the job description.</p>'}
                            
                            ${matchingScore.missing_skills && matchingScore.missing_skills.length > 0 ? `
                                <div class="mb-3">
                                    <p class="mb-2"><strong>‚úó Missing Skills (${matchingScore.missing_skills.length}):</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${matchingScore.missing_skills.map(skill => `
                                            <span class="badge bg-danger">${skill}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${matchingScore.details && matchingScore.details.length > 0 ? `
                                <div class="mt-3">
                                    <p class="mb-2"><strong>üìù Detailed Feedback:</strong></p>
                                    <ul class="mb-0">
                                        ${matchingScore.details.map(detail => `<li>${detail}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 p-2 bg-light rounded">
                                <small class="text-muted">
                                    <strong>üí° Matching Algorithm:</strong> This score is calculated based on weighted factors: 
                                    Skills (50%), Experience (30%), and Education (20%). The algorithm uses keyword matching 
                                    and considers both required and bonus qualifications.
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Debug: Check if diagnostics exists
            if (!diagnostics || Object.keys(diagnostics).length === 0) {
                if (!matchingScore) {
                    html += `
                        <div class="alert alert-warning">
                            <p class="mb-0">‚ö†Ô∏è Detailed diagnostics are not available for this resume.</p>
                            <small>This may occur with older analysis results or if the document format is not fully supported.</small>
                        </div>
                    `;
                }
                return html;
            }
            
            html += '<h6 class="text-primary mb-3">üîç Authenticity Analysis Details</h6>';
            
            // LinkedIn Diagnostics - Enhanced with separate Resume/Online sections
            if (diagnostics.linkedin) {
                html += `<div class="mb-4"><h6 class="text-primary">üîó Professional Profile Analysis</h6>`;
                
                // Section 1: Resume Presence
                if (diagnostics.linkedin.profile) {
                    const profile = diagnostics.linkedin.profile;
                    const resumeStatus = profile.cross_verified ? 'success' : 'warning';
                    html += `
                        <div class="alert alert-${resumeStatus} mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">üìÑ</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Found in Resume</strong></p>
                                    <p class="mb-1">
                                        <strong>LinkedIn URL:</strong> 
                                        <a href="${profile.url}" target="_blank" class="text-decoration-none">
                                            ${profile.url}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16" style="margin-left: 4px;">
                                                <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                                                <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                                            </svg>
                                        </a>
                                    </p>
                                    <p class="mb-0"><strong>Username:</strong> <code>${profile.username}</code></p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (diagnostics.linkedin.verification_details) {
                    // Show "Not Found in Resume" when we have online verification but no resume profile
                    html += `
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">üìÑ</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Not Found in Resume</strong></p>
                                    <p class="mb-0"><small>No LinkedIn URL detected in the resume. However, we found a profile through online search (see below).</small></p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Section 2: Online Verification (Enhanced)
                if (diagnostics.linkedin.verification_details) {
                    const details = diagnostics.linkedin.verification_details;
                    html += `
                        <div class="alert alert-info mb-3" style="border-left: 4px solid #0077b5;">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">üîç</span>
                                <div style="flex: 1;">
                                    <p class="mb-2"><strong>Online Verification Results</strong></p>
                                    <div class="mb-2">
                                        <span class="badge bg-success me-2">‚úì Verified</span>
                                        <span class="badge bg-info">via ${details.search_engine}</span>
                                    </div>
                                    
                                    ${details.search_url ? `
                                        <p class="mb-2">
                                            <strong>Verification Source:</strong><br>
                                            <a href="${details.search_url}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16" style="margin-right: 4px;">
                                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                                </svg>
                                                View ${details.search_engine} Search: "${details.search_query}"
                                            </a>
                                        </p>
                                    ` : ''}
                                    
                                    ${details.matched_profiles && details.matched_profiles.length > 0 ? `
                                        <div class="mt-2">
                                            <strong>Matched LinkedIn Profile(s):</strong>
                                            <ul class="list-unstyled mt-1 mb-0">
                                                ${details.matched_profiles.slice(0, 3).map(profile => {
                                                    // Add https:// if not present
                                                    const profileUrl = profile.startsWith('http') ? profile : 'https://' + profile;
                                                    return `
                                                    <li class="mb-1">
                                                        <a href="${profileUrl}" target="_blank" class="text-decoration-none">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#0077b5" class="bi bi-linkedin" viewBox="0 0 16 16">
                                                                <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/>
                                                            </svg>
                                                            ${profile}
                                                        </a>
                                                    </li>
                                                `}).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="mt-2 p-2 bg-light rounded">
                                        <small class="text-muted">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                            </svg>
                                            <strong>Why this matters:</strong> HR can click the verification link to confirm this is the correct person and not someone with a similar name.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (diagnostics.linkedin.profile && diagnostics.linkedin.profile.cross_verified === false) {
                    // Show warning if found in resume but not verified
                    html += `
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-start">
                                <span style="font-size: 1.5rem; margin-right: 12px;">‚ö†Ô∏è</span>
                                <div style="flex: 1;">
                                    <p class="mb-1"><strong>Could Not Verify Online</strong></p>
                                    <small>The LinkedIn profile from the resume could not be found through online search. This may indicate a deleted profile or privacy settings.</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Alternative Profiles
                if (diagnostics.linkedin.alternatives && diagnostics.linkedin.alternatives.length > 0) {
                    html += `
                        <div class="alert alert-secondary mb-3">
                            <p class="mb-2"><strong>Alternative Profiles Found:</strong></p>
                            <ul class="mb-0">
                                ${diagnostics.linkedin.alternatives.map(alt => `
                                    <li>
                                        <strong>${alt.platform}:</strong> 
                                        <a href="${alt.url}" target="_blank" class="text-decoration-none">
                                            ${alt.url}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 2px;">
                                                <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                                                <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                                            </svg>
                                        </a>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            // Capitalization Diagnostics
            if (diagnostics.capitalization) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">‚úçÔ∏è Capitalization Analysis</h6>
                        <p><strong>Issues Found:</strong> ${diagnostics.capitalization.issues_found}</p>
                        ${diagnostics.capitalization.details.map(issue => `
                            <div class="alert alert-${issue.severity === 'high' ? 'danger' : issue.severity === 'medium' ? 'warning' : 'info'} mb-2">
                                <h6 class="alert-heading">${issue.type}</h6>
                                ${issue.message ? `<p class="mb-0">${issue.message}</p>` : ''}
                                ${issue.count ? `<p class="mb-1"><strong>Count:</strong> ${issue.count} occurrences</p>` : ''}
                                ${issue.examples ? `
                                    <p class="mb-1"><strong>Examples:</strong></p>
                                    ${Array.isArray(issue.examples) ? `
                                        <ul class="mb-1">
                                            ${issue.examples.map(ex => `<li><code>${typeof ex === 'object' ? JSON.stringify(ex) : ex}</code></li>`).join('')}
                                        </ul>
                                    ` : `<code>${JSON.stringify(issue.examples)}</code>`}
                                ` : ''}
                                ${issue.fix ? `<p class="mb-0"><strong>üí° Fix:</strong> ${issue.fix}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Font Diagnostics
            if (diagnostics.fonts) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">üî§ Font Usage Analysis</h6>
                        <div class="alert alert-info">
                            <p class="mb-2"><strong>${diagnostics.fonts.recommendation}</strong></p>
                            <p class="mb-1"><strong>Total Unique Fonts:</strong> ${diagnostics.fonts.total_unique_fonts}</p>
                            ${diagnostics.fonts.fonts_breakdown && Object.keys(diagnostics.fonts.fonts_breakdown).length > 0 ? `
                                <p class="mb-1"><strong>Font Breakdown:</strong></p>
                                <ul class="mb-0">
                                    ${Object.entries(diagnostics.fonts.fonts_breakdown).map(([font, count]) => `
                                        <li><strong>${font}:</strong> ${count} ${typeof count === 'number' ? 'times' : ''}</li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Grammar Diagnostics
            if (diagnostics.grammar) {
                html += `
                    <div class="mb-4">
                        <h6 class="text-primary">üìù Grammar & Content Analysis</h6>
                        <p><strong>Issues Found:</strong> ${diagnostics.grammar.issues_found}</p>
                        ${diagnostics.grammar.details.map(issue => `
                            <div class="alert alert-${issue.severity === 'high' ? 'danger' : issue.severity === 'medium' ? 'warning' : 'info'} mb-2">
                                <h6 class="alert-heading">${issue.type}</h6>
                                ${issue.message ? `<p class="mb-0">${issue.message}</p>` : ''}
                                ${issue.count ? `<p class="mb-1"><strong>Count:</strong> ${issue.count} occurrences</p>` : ''}
                                ${issue.examples ? `
                                    <p class="mb-1"><strong>Examples:</strong></p>
                                    <ul class="mb-1">
                                        ${issue.examples.map(ex => `<li><code>${ex}</code></li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${issue.fix ? `<p class="mb-0"><strong>üí° Fix:</strong> ${issue.fix}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return html;
        }

        function displayBatchResults(batchResult) {
            const { total_processed, successful, failed, results, errors } = batchResult;
            
            let html = `
                <h6>Batch Analysis Complete</h6>
                <div class="alert alert-info mb-3">
                    <strong>Summary:</strong> Processed ${total_processed} files | 
                    ‚úì ${successful} successful | 
                    ${failed > 0 ? `‚úó ${failed} failed` : 'All successful'}
                </div>
            `;

            // Display errors if any
            if (errors && errors.length > 0) {
                html += `
                    <div class="alert alert-warning mb-3">
                        <h6 class="alert-heading">‚ö†Ô∏è Some files failed:</h6>
                        <ul class="mb-0">
                            ${errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Display successful results
            if (results && results.length > 0) {
                html += `<div class="accordion" id="batchResultsAccordion">`;
                
                results.forEach((result, index) => {
                    const avgScore = result.authenticity_score?.overall_score || 0;
                    const scoreColor = avgScore >= 80 ? 'success' : avgScore >= 60 ? 'warning' : 'danger';
                    
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                    <span class="badge bg-${scoreColor} me-2">${Math.round(avgScore)}%</span>
                                    ${result.filename}
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                 data-bs-parent="#batchResultsAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>üìä Authenticity Scores</h6>
                                            <p><strong>Overall:</strong> ${Math.round(result.authenticity_score?.overall_score || 0)}%</p>
                                            <p><strong>Font:</strong> ${Math.round(result.authenticity_score?.font_consistency || 0)}%</p>
                                            <p><strong>Grammar:</strong> ${Math.round(result.authenticity_score?.grammar_score || 0)}%</p>
                                            <p><strong>Formatting:</strong> ${Math.round(result.authenticity_score?.formatting_score || 0)}%</p>
                                            <p><strong>LinkedIn:</strong> ${Math.round(result.authenticity_score?.linkedin_profile_score || 0)}%</p>
                                            <p><strong>Capitalization:</strong> ${Math.round(result.authenticity_score?.capitalization_score || 0)}%</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>üìã Details</h6>
                                            <p><strong>Size:</strong> ${(result.file_size / 1024).toFixed(1)} KB</p>
                                            
                                            ${result.matching_score ? `
                                                <div class="mt-2">
                                                    <h6>üéØ JD Match: ${Math.round(result.matching_score.overall_match)}%</h6>
                                                    <div class="progress mb-2" style="height: 20px;">
                                                        <div class="progress-bar bg-${getScoreColor(result.matching_score.overall_match)}"
                                                             style="width: ${result.matching_score.overall_match}%">
                                                            ${Math.round(result.matching_score.overall_match)}%
                                                        </div>
                                                    </div>
                                                    <small>
                                                        Skills: ${Math.round(result.matching_score.skills_match)}% | 
                                                        Experience: ${Math.round(result.matching_score.experience_match)}% | 
                                                        Education: ${Math.round(result.matching_score.education_match)}%
                                                    </small>
                                                </div>
                                            ` : ''}
                                            
                                            ${result.authenticity_score?.flags && result.authenticity_score.flags.length > 0 ? `
                                                <div class="mt-3">
                                                    <strong>üö© Flags:</strong>
                                                    <ul class="list-unstyled mb-0 mt-1">
                                                        ${result.authenticity_score.flags.map(flag => `
                                                            <li class="mb-1">
                                                                <span class="badge bg-${flag.severity === 'high' ? 'danger' : flag.severity === 'medium' ? 'warning' : 'info'}" 
                                                                      style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                                                    ${flag.severity === 'high' ? 'üî¥' : flag.severity === 'medium' ? 'üü°' : '‚ÑπÔ∏è'}
                                                                </span>
                                                                <span style="font-size: 0.875rem;">${flag.message}</span>
                                                            </li>
                                                        `).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            
                                            <div class="mt-2">
                                                <small class="text-muted">${(result.authenticity_score?.details || []).join('<br>')}</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Detailed Diagnostics Button for Batch Item -->
                                    <div class="mt-3 text-center">
                                        <button class="btn btn-outline-primary btn-sm" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#batchDiagnostics${index}">
                                            üîç View Detailed Diagnostics
                                        </button>
                                    </div>
                                    
                                    <!-- Detailed Diagnostics Collapse for Batch Item -->
                                    <div class="collapse mt-3" id="batchDiagnostics${index}">
                                        <div class="card card-body">
                                            ${generateDiagnosticsHTML(result.authenticity_score?.diagnostics || {}, result.matching_score)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }

            document.getElementById('resultsContent').innerHTML = html;
        }
    </script>
</body>
</html>
